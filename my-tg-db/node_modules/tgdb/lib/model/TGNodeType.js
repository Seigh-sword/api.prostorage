/**
 * Copyright 2016 TIBCO Software Inc. All rights reserved.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License"); You may not use this file except 
 * in compliance with the License.
 * A copy of the License is included in the distribution package with this file.
 * You also may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

var TGEntityType     = require('./TGEntityType'),
	TGAttributeType  = require('./TGAttributeType'),
	TGAttributeDescriptor = require('./TGAttributeDescriptor').TGAttributeDescriptor,
    TGSystemObject = require('./TGSystemObject').TGSystemObject,
    util             = require('util'),
    TGLogManager    = require('../log/TGLogManager'),
    TGLogLevel      = require('../log/TGLogger').TGLogLevel;

var logger = TGLogManager.getLogger();

function TGNodeType(graphMetadata, name, parentNodeType) {
	TGNodeType.super_.call(this);
	// Since 1.1
	this._pKeys = [];  // an array of attribute descriptors
    this._idxIds = []; // an array of integer
    this._numEntries;  // need to be long?
}

util.inherits(TGNodeType, TGEntityType);

TGNodeType.prototype.getSystemType = function() {
    return TGSystemObject.TGSystemType.NodeType;
};

// Since 1.1
TGNodeType.prototype.updateMetadata = function(gmd) {
    this.updateEntityMetadata(gmd);
    for (var i=0; i<this._pKeys.length; i++) {
    	var attrName = this._pKeys[i].getName();
        var desc = gmd.getAttributeDescriptor(attrName);
        if (!(!desc)) {
            this._pKeys[i] = desc;
        } else {
	        logger.logWarning("Cannot find attribute descriptor pkey attribute : %s", attrName);
        }
    }
};

// Since 1.1
TGNodeType.prototype.getPKeyAttributeDescriptors = function() {
    return this._pKeys;
};

TGNodeType.prototype.readExternal = function(inputStream) {
	this.readAttributeDescriptors(inputStream);
	
	var attrCount = inputStream.readShort();
	for(var i=0; i<attrCount; i++) {
		// Modified for 1.1
        var attrName = inputStream.readUTF();
		var attrDesc = new TGAttributeDescriptor(attrName, TGAttributeType.STRING, false);
		this._pKeys.push(attrDesc);
	}
	
	var idxCount = inputStream.readShort();
	for (var i=0; i<idxCount; i++) {
        //FIXME: Get meta data needs to return index definitions
		// Since 1.1
        idxIds.add(inputStream.readInt());
	}
	// Since 1.1
	this._numEntries = inputStream.readLong();
};

module.exports = TGNodeType;