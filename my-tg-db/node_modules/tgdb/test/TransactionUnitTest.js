/**
 * Copyright 2016 TIBCO Software Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); You may not use this file except
 * in compliance with the License.
 * A copy of the License is included in the distribution package with this file.
 * You also may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.	
 */

var conFactory    = require('../lib/connection/TGConnectionFactory'),
	TGEdgeDirectionType = require('../lib/model/TGEdgeDirectionType').TGEdgeDirectionType,
	TGQueryOption = require('../lib/query/TGQueryOption').TGQueryOption,
	PrintUtility  = require('../lib/utils/PrintUtility'),
    TGLogManager  = require('../lib/log/TGLogManager'),
    TGLogLevel    = require('../lib/log/TGLogger').TGLogLevel;

var logger = TGLogManager.getLogger();
var conn = null;
var gof = null;
var graphMetadata = null;
var basicNodeType = null;
var rateNodeType = null;
var testNodeType = null;
var john, smith, kelly;  // node
var brother, wife;  // edge

function testSuite(){
	testCase1(function() {
		testCase1_1(function(){
			testCase1_2(function(){
				testCase2(function(){
					testCase3(function(){
						testCase3_1(function(){
							testCase4(function(){
								testCase4_0(function(){
									testCase5(function(){
										testCase6(function(){
											testCase6_1(function(){
												testCase7(function(){
												});
											});
										});
									});
								});
							});
						});						
					});
				});
			});
		});
	});
}

var keyName1 = "Gabe";
var keyName2 = "Georgia";
function testCase1(callback)
{
    try {
		logger.logInfo("\n\n\nTest Case 1: Insert Simple Node(John) of basicnode with a few properties");

        var node = createNode(gof, basicNodeType);

        node.setStringAttribute("name", keyName1); //name is the primary key
        node.setIntegerAttribute("age", 30);
        node.setStringAttribute("nickname", "美麗");
        node.setDateTimeAttribute("createtm", new Date(2016, 10, 25, 15, 9, 30, 999));

        node.setNumberAttribute("networth", "2378989.567");
        node.setCharAttribute("flag", 'D');

        conn.insertEntity(node);
        conn.commit(function(){
            john = node;
            if(callback) {
                callback();
            }
        });
    }
    catch (err) {
		logger.logError("Error : %s", err.message);
    }
}

function testCase1_1(callback)
{
	logger.logInfo("\n\n\nTest Case 1_0: Get the Entity that we inserted");
    var key = gof.createCompositeKey("basicnode");
    key.setAttribute("name", "Gabe");
    var option = TGQueryOption.createQueryOption();
    conn.getEntity(key, option, function(entity){
    	//if (entity instanceof TGNode) {
    		logger.logInfo("John's age is :" + entity.getAttribute("age").getValue());
    		logger.logInfo("John's createtm:" + entity.getAttribute("createtm").getValue());
    		logger.logInfo("John's networth:" + entity.getAttribute("networth").getValue());
    	//}
    	john = entity;
        if(callback) {
            callback();
        }
    });
}

function testCase1_2(callback)
{
    try {
    	logger.logInfo("\n\n\nTest Case 1_2: Again insert John. This should raise Unique Key Constraint violation.");
        var node = createNode(gof, basicNodeType);
        node.setStringAttribute("name", "john");
        node.setIntegerAttribute("age", 30);
        node.setStringAttribute("nickname", "美麗");
        conn.insertEntity(node);
        conn.commit(function(){
            if(callback) {
                callback();
            }
        });
    }
    catch (err) {
		logger.logError("Error : %s", err.message);
    }
}

function testCase2(callback)
{
	logger.logInfo("\n\n\nTest Case 2: Update Node John's attribute.");
    john.setIntegerAttribute("age", 35);
    //john.setStringAttribute("nickname", "麗美"); //swapped the character
    john.setStringAttribute("nickname", "This is a long nickname"); //swapped the character
    conn.updateEntity(john);
    conn.commit(function(){
        if(callback) {
            callback();
        }
    }); //Should be successful.
}

function testCase3(callback)
{
    try {
        logger.logInfo("\n\n\nTest Case 3: Insert 2 nodes, and set a relation between them");
        smith = createNode(gof, basicNodeType);
        smith.setStringAttribute("name", "smith"); //name is the primary key
        smith.setIntegerAttribute("age", 30);
        smith.setStringAttribute("nickname", "will");
        conn.insertEntity(smith);

        kelly = createNode(gof, basicNodeType);
        kelly.setStringAttribute("name", "kelly"); //name is the primary key
        kelly.setIntegerAttribute("age", 28);
        kelly.setStringAttribute("nickname", "Ki");
        conn.insertEntity(kelly);

        brother = gof.createEdge(smith, kelly, TGEdgeDirectionType.DIRECTED);
        brother.setStringAttribute("name", "Sister");
        conn.insertEntity(brother);

        conn.commit(function(){
            if(callback) {
                callback();
            }
        });
    }
    catch (err) {
		logger.logError("Error : %s", err.message);
    }

}

function testCase3_1(callback)
{
    logger.logInfo("\n\n\nTest Case 3_1: Get the Entity that we inserted");
    var key = gof.createCompositeKey("basicnode");
    key.setAttribute("name", "smith");;
    var entity = conn.getEntity(key, TGQueryOption.DEFAULT_QUERY_OPTION, function(entity){
//        if (entity instanceof TGNode) {
    	logger.logInfo("John's age is :" + entity.getAttribute("age").getValue());
//        }
    	if(callback) {
    		callback();
    	}
    });
}

function testCase4(callback)
{
    try {
        logger.logInfo("\n\n\nTest Case 4: Add an edge between 2 existing nodes - In case between john and kelly");
        wife = gof.createEdge(kelly, john, TGEdgeDirectionType.DIRECTED);
        wife.setStringAttribute("name", "wife");
        conn.insertEntity(wife);

        conn.commit(function(){
            if(callback) {
                callback();
            }
        });
    }
    catch (err) {
		logger.logError("Error : %s", err.message);
        wife = null;
    }
}

function testCase4_0(callback)
{
    logger.logInfo("\n\n\nTest Case 4_0: Get the Entity that we inserted");
    var key = gof.createCompositeKey("basicnode");
    key.setAttribute("name", "kelly");;
    conn.getEntity(key, TGQueryOption.DEFAULT_QUERY_OPTION, function(entity){
//        if (entity instanceof TGNode) {
            logger.logInfo("Kelly's age is :" + entity.getAttribute("age").getValue());
//        }
        kelly = entity;
        if(callback) {
            callback();
        }
    });
}

function testCase5(callback)
{
    logger.logInfo("\n\n\nTest Case 5: Update an existing Edge");
    if (!(!wife)) {
        wife.setStringAttribute("name", "wife");
        wife.setStringAttribute("dom", "10/2/2016");  //Adding date of marriage
        conn.updateEntity(wife);
        conn.commit(function(){
            if(callback) {
                callback();
            }
        });
    }
}

function testCase6(callback)
{
    logger.logInfo("\n\n\nTest Case 6: Deleting Node 1");
    conn.deleteEntity(john);
    conn.commit(function(){
        if(callback) {
            callback();
        }
    });
}

function testCase6_1(callback)
{
    try {
        logger.logInfo("\n\n\nTest Case 6_1: Updating Node 1 Again - Should throw mismatch of ERA. or deleted");
        john.setIntegerAttribute("age", 40);
        john.setStringAttribute("nickname", "美麗"); //swapped the character
        conn.updateEntity(john);
        conn.commit(function(){
            if(callback) {
                callback();
            }
        });
    }
    catch (err) {
		logger.logError("Error : %s", err.message);
    }
}

function testCase7(callback)
{
    logger.logInfo("\n\n\nTest Case 7: Deleting Egde");
    conn.deleteEntity(brother);
    conn.commit(function(){
        if(callback) {
            callback();
        }
    });
}

function start() {
	var logger = TGLogManager.getLogger();
	logger.setLevel(TGLogLevel.DebugWire);

    var connectionFactory = conFactory.getFactory();
    var linkURL = 'tcp://scott@192.168.1.8:8222';
    conn = connectionFactory.createConnection(linkURL, 'scott', 'scott', null);

    conn.connect(function(connectionStatus) {
        if (connectionStatus) {
        	logger.logInfo('Connection to server successful');
            gof = conn.getGraphObjectFactory();

    	    conn.getGraphMetadata(true, function(gmd) {
    	    	graphMetadata = gmd;

    	        basicNodeType = gmd.getNodeType("basicnode");
    	        if (!basicNodeType) throw new Exception("Node type basicnode not found");

    	        rateNodeType = gmd.getNodeType("ratenode");
    	        if (!rateNodeType) throw new Exception("Node type ratenode not found");

    	        testNodeType = gmd.getNodeType("testnode");
    	        if (!testNodeType) throw new Exception("Node type testnode not found");

    	        testSuite();
    		});
        }
    });
}

function createNode(gof, nodeType) {
	if (!nodeType) {
		return gof.createNode();
	} else {
		return gof.createNode(nodeType);
	}
}

function main() {
	start();
}

main();
